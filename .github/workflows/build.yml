# github-build --organization Cloud-Officer --mono_repo --skip_license_check --skip_slack
---
name: Build
'on':
  pull_request:
    types:
    - opened
    - edited
    - reopened
    - synchronize
  push:
    branches:
    - master
    - "[0-9]*"
    - dependabot/**
    tags:
    - "**"
permissions:
  contents: read
  pull-requests: read
env:
  NODE-VERSION: 25.7.0
jobs:
  variables:
    name: Prepare Variables
    runs-on: ubuntu-latest
    outputs:
      BUILD_NAME: "${{steps.variables.outputs.BUILD_NAME}}"
      BUILD_VERSION: "${{steps.variables.outputs.BUILD_VERSION}}"
      COMMIT_MESSAGE: "${{steps.variables.outputs.COMMIT_MESSAGE}}"
      MODIFIED_GITHUB_RUN_NUMBER: "${{steps.variables.outputs.MODIFIED_GITHUB_RUN_NUMBER}}"
      DEPLOY_ON_BETA: "${{steps.variables.outputs.DEPLOY_ON_BETA}}"
      DEPLOY_ON_RC: "${{steps.variables.outputs.DEPLOY_ON_RC}}"
      DEPLOY_ON_PROD: "${{steps.variables.outputs.DEPLOY_ON_PROD}}"
      DEPLOY_MACOS: "${{steps.variables.outputs.DEPLOY_MACOS}}"
      DEPLOY_TVOS: "${{steps.variables.outputs.DEPLOY_TVOS}}"
      DEPLOY_OPTIONS: "${{steps.variables.outputs.DEPLOY_OPTIONS}}"
      SKIP_LICENSES: "${{steps.variables.outputs.SKIP_LICENSES}}"
      SKIP_LINTERS: "${{steps.variables.outputs.SKIP_LINTERS}}"
      SKIP_TESTS: "${{steps.variables.outputs.SKIP_TESTS}}"
      UPDATE_PACKAGES: "${{steps.variables.outputs.UPDATE_PACKAGES}}"
      LINTERS: "${{steps.variables.outputs.LINTERS}}"
    timeout-minutes: 30
    steps:
    - name: Prepare variables
      id: variables
      uses: cloud-officer/ci-actions/variables@v2
      with:
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  actionlint:
    name: Github Actions Linter
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: Actionlint
      id: actionlint
      uses: cloud-officer/ci-actions/linters/actionlint@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  eslint:
    name: JavaScript ES Linter
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: ESLint
      id: eslint
      uses: cloud-officer/ci-actions/linters/eslint@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  markdownlint:
    name: Markdown Linter
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: Markdownlint
      id: markdownlint
      uses: cloud-officer/ci-actions/linters/markdownlint@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  semgrep:
    name: Semgrep Security Scanner
    permissions:
      actions: read
      contents: read
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: Semgrep
      uses: cloud-officer/ci-actions/linters/semgrep@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  shellcheck:
    name: Shell Scripts Linter
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: ShellCheck
      id: shellcheck
      uses: cloud-officer/ci-actions/linters/shellcheck@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  trivy:
    name: Container & IaC Vulnerability Scanner
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: Trivy
      uses: cloud-officer/ci-actions/linters/trivy@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  yamllint:
    name: YAML Linter
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_LINTERS != '1' && github.event_name == 'pull_request'}}"
    timeout-minutes: 30
    steps:
    - name: Yamllint
      id: yamllint
      uses: cloud-officer/ci-actions/linters/yamllint@v2
      with:
        linters: "${{needs.variables.outputs.LINTERS}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
  js_unit_tests:
    name: JavaScript Unit Tests
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_TESTS != '1'}}"
    timeout-minutes: 30
    steps:
    - name: Setup
      uses: cloud-officer/ci-actions/setup@v2
      with:
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
        aws-access-key-id: "${{secrets.AWS_ACCESS_KEY_ID}}"
        aws-secret-access-key: "${{secrets.AWS_SECRET_ACCESS_KEY}}"
        aws-region: "${{secrets.AWS_DEFAULT_REGION}}"
        node-version: "${{env.NODE-VERSION}}"
    - name: NPM (slack)
      shell: bash
      run: cd slack && npm ci
      env:
        GITHUB_TOKEN: "${{secrets.GH_PAT}}"
    - name: Jest (slack)
      shell: bash
      run: cd slack && npm test
      env:
        GITHUB_TOKEN: "${{secrets.GH_PAT}}"
  shell_script_unit_tests:
    name: Shell Script Unit Tests
    runs-on: ubuntu-latest
    needs:
    - variables
    if: "${{needs.variables.outputs.SKIP_TESTS != '1'}}"
    timeout-minutes: 30
    steps:
    - name: Setup
      uses: cloud-officer/ci-actions/setup@v2
      with:
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.GH_PAT}}"
        aws-access-key-id: "${{secrets.AWS_ACCESS_KEY_ID}}"
        aws-secret-access-key: "${{secrets.AWS_SECRET_ACCESS_KEY}}"
        aws-region: "${{secrets.AWS_DEFAULT_REGION}}"
    - name: Bats Install (variables)
      shell: bash
      run: cd variables && sudo apt-get update && sudo apt-get install -y bats
      env:
        GITHUB_TOKEN: "${{secrets.GH_PAT}}"
    - name: Bats (variables)
      shell: bash
      run: cd variables && bats tests/
      env:
        GITHUB_TOKEN: "${{secrets.GH_PAT}}"
